<script>
  function keypressAndReturn(event) {
    // Capture all the keypresses and if they are a return, 
    // then "click" the send button
    event.stopPropagation();
    var keycode = (event.keyCode ? event.keyCode : event.which);
    //console.log(keycode);
    if (keycode == '13') {
      $("#send").click();
      return true;
    }
    return false;
  }
  var kpMode = "<%= Settings.datawedge_kp_mode %>";
  // var clickedBtn; var code; Gestisco il keypress sull'input
  $("input[name=barcode]").on(kpMode, keypressAndReturn);

  function resetCurrentBtn() {
    $("#send").button('reset');
    $("#barcode").prop('disabled', false);
    $("#barcode").val('');
    // sendMessageToServer(msg_input_plugin_enable); clickedBtn = code = null;
  }
  // var clickedBtn; var code; Gestisco il keypress sull'input
  function manageScannedKeystrokes(event) {
    if(!keypressAndReturn(event)) {
      $("#send").focus();
      // Scrivilo nell'input field (accumulando)
      $("input[name=barcode]").val(function (index, val) {
        // Scrivo
        return val + event.key;
      });
    }
  }
  function enableKSCapture(){
    $(document).on(kpMode, manageScannedKeystrokes);
  }
  function disableKSCapture(){
    $(document).off(kpMode, manageScannedKeystrokes);
  }

  // Init
  enableKSCapture();
  // Se $("#barcode") si becca il focus, elimino il keypress
  $("#barcode").focusin(function () {
    // Blocco il keypress del document
    disableKSCapture();
  });
  $("#barcode").focusout(function () {
    // Blocco il keypress del document
    enableKSCapture();
  });
  $("#send").focus();
</script>
