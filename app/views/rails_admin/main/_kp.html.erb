<script>
  function keypressAndReturn(event) {
    // Capture all the keypresses and if they are a return, 
    // then "click" the send button
    event.stopPropagation();
    var keycode = (event.keyCode ? event.keyCode : event.which);
    // console.log(keycode);
    if (keycode == '13') {
      $("#send").click();
      return true;
    }
    return false;
  }
  var kpMode = "<%= Settings.datawedge_kp_mode %>";
  // var clickedBtn; var code; Gestisco il keypress sull'input
  // $("#barcode").on(kpMode, keypressAndReturn);

  function resetCurrentBtn() {
    $("#send").button('reset');
    $("#barcode").prop('disabled', false);
    $("#barcode").val('');
    // sendMessageToServer(msg_input_plugin_enable); clickedBtn = code = null;
  }
  // var clickedBtn; var code; Gestisco il keypress sull'input
  function manageScannedKeystrokes(event) {
    // console.log(event);
    event.stopPropagation();
    if(!keypressAndReturn(event)) {
      // $("#send").focus();
      // Scrivilo nell'input field (accumulando)
      // Only if target.id is different from "barcode"
      // Otherwise well get duplicate keystrokes
      if(event.target.id != "barcode")
      $("#barcode").val(function (index, val) {
        // Write
        return val + event.key;
      });
    }
  }
  function enableKSCapture(){
    $(document).on(kpMode, manageScannedKeystrokes);
    $("#barcode").off(kpMode, manageScannedKeystrokes);
  }
  function disableKSCapture(){
    $(document).off(kpMode, manageScannedKeystrokes);
    $("#barcode").on(kpMode, manageScannedKeystrokes);
  }

  // $("#send").focus();
  // Init
  // Disabling any previously defined keypress event
  $(document).off(kpMode);
  $("#barcode").off(kpMode);
  $("#barcode").focus();
  // Enabling keypress event only for this page
  <%-unless (start_disabled rescue false)%>
  disableKSCapture();
  <%-else%>
  enableKSCapture();
  <%-end%>
  // Se $("#barcode") si becca il focus, elimino il keypress
  $("#barcode").focusin(function () {
    // Blocco il keypress del document
    disableKSCapture();
  });
  $("#barcode").focusout(function () {
    // Blocco il keypress del document
    enableKSCapture();
  });
</script>
